<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>Session Management - Multi-Sensor Recording Dashboard</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>

    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --light-bg: #ecf0f1;
            --dark-bg: #34495e;
        }

        body {
            background-color: var(--light-bg);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .navbar {
            background: linear-gradient(135deg, var(--primary-color), var(--dark-bg));
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .navbar-brand {
            font-weight: bold;
            color: white !important;
        }

        .session-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            border: none;
            margin-bottom: 20px;
        }

        .session-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
            animation: pulse 2s infinite;
        }

        .status-active {
            background-color: var(--success-color);
        }

        .status-recording {
            background-color: var(--danger-color);
        }

        .status-completed {
            background-color: var(--secondary-color);
        }

        .status-error {
            background-color: var(--danger-color);
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .real-time-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--success-color);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            z-index: 1000;
        }

        .real-time-indicator.disconnected {
            background: var(--danger-color);
        }

        .session-stats {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }

        .btn-custom {
            border-radius: 6px;
            padding: 6px 12px;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.2s ease;
        }
    </style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-dark">
    <div class="container">
        <a class="navbar-brand" href="/">
            <i class="fas fa-chart-line me-2"></i>
            Multi-Sensor Recording Dashboard
        </a>
        <button class="navbar-toggler" data-bs-target="#navbarNav" data-bs-toggle="collapse" type="button">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ms-auto">
                <li class="nav-item">
                    <a class="nav-link" href="/">
                        <i class="fas fa-tachometer-alt me-1"></i>Dashboard
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/devices">
                        <i class="fas fa-devices me-1"></i>Devices
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link active" href="/sessions">
                        <i class="fas fa-history me-1"></i>Sessions
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/playback">
                        <i class="fas fa-play me-1"></i>Playback
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/files">
                        <i class="fas fa-folder me-1"></i>File Viewer
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/settings">
                        <i class="fas fa-cog me-1"></i>Settings
                    </a>
                </li>
            </ul>
        </div>
    </div>
</nav>

<div class="real-time-indicator" id="connectionIndicator">
    <i class="fas fa-wifi me-1"></i>
    <span id="connectionStatus">Connected</span>
</div>

<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <h2 class="mb-4">
                <i class="fas fa-history me-2"></i>Session Management
            </h2>
        </div>
    </div>

    <div class="row">
        <div class="col-12 mb-4">
            <div class="card session-card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-record-vinyl me-2 text-danger"></i>Current Session
                    </h5>
                    <div class="btn-group" role="group">
                        <button class="btn btn-success btn-custom" id="startNewSessionBtn">
                            <i class="fas fa-play me-1"></i>Start New Session
                        </button>
                        <button class="btn btn-danger btn-custom" disabled id="stopCurrentSessionBtn">
                            <i class="fas fa-stop me-1"></i>Stop Current
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div id="currentSessionContent">
                        <div class="text-center text-muted p-4">
                            <i class="fas fa-play-circle fa-3x mb-3"></i>
                            <h5>No Active Session</h5>
                            <p>Start a new recording session to begin data collection</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-12 mb-4">
            <div class="card session-card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-list me-2"></i>Session History
                    </h5>
                    <div class="btn-group" role="group">
                        <button class="btn btn-outline-primary btn-custom" onclick="refreshSessions()">
                            <i class="fas fa-sync-alt me-1"></i>Refresh
                        </button>
                        <button class="btn btn-outline-secondary btn-custom" onclick="exportSessions()">
                            <i class="fas fa-download me-1"></i>Export
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div id="sessionHistoryContent">
                        <div class="text-center text-muted p-4">
                            <i class="fas fa-search fa-2x mb-2"></i>
                            <p>Loading session history...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card session-card">
                <div class="card-body text-center">
                    <i class="fas fa-clock fa-2x text-primary mb-2"></i>
                    <h5 class="card-title">Total Sessions</h5>
                    <h3 class="text-primary" id="totalSessions">0</h3>
                    <p class="text-muted mb-0">Recorded</p>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card session-card">
                <div class="card-body text-center">
                    <i class="fas fa-stopwatch fa-2x text-info mb-2"></i>
                    <h5 class="card-title">Total Duration</h5>
                    <h3 class="text-info" id="totalDuration">0h 0m</h3>
                    <p class="text-muted mb-0">Recording Time</p>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card session-card">
                <div class="card-body text-center">
                    <i class="fas fa-database fa-2x text-success mb-2"></i>
                    <h5 class="card-title">Data Collected</h5>
                    <h3 class="text-success" id="totalDataSize">0 MB</h3>
                    <p class="text-muted mb-0">Total Size</p>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card session-card">
                <div class="card-body text-center">
                    <i class="fas fa-chart-line fa-2x text-warning mb-2"></i>
                    <h5 class="card-title">Success Rate</h5>
                    <h3 class="text-warning" id="successRate">100%</h3>
                    <p class="text-muted mb-0">Completion</p>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="newSessionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-plus me-2"></i>Start New Recording Session
                </h5>
                <button class="btn-close" data-bs-dismiss="modal" type="button"></button>
            </div>
            <div class="modal-body">
                <form id="newSessionForm">
                    <div class="mb-3">
                        <label class="form-label" for="sessionName">Session Name</label>
                        <input class="form-control" id="sessionName" placeholder="Enter session name" type="text">
                    </div>
                    <div class="mb-3">
                        <label class="form-label" for="sessionDescription">Description</label>
                        <textarea class="form-control" id="sessionDescription" placeholder="Optional description"
                                  rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Recording Devices</label>
                        <div class="form-check">
                            <input class="form-check-input" id="device_android_1" type="checkbox" value="android_1">
                            <label class="form-check-label" for="device_android_1">Android Device 1</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" id="device_android_2" type="checkbox" value="android_2">
                            <label class="form-check-label" for="device_android_2">Android Device 2</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" id="device_webcam_1" type="checkbox" value="webcam_1">
                            <label class="form-check-label" for="device_webcam_1">USB Webcam 1</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" id="device_webcam_2" type="checkbox" value="webcam_2">
                            <label class="form-check-label" for="device_webcam_2">USB Webcam 2</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" id="device_shimmer_1" type="checkbox" value="shimmer_1">
                            <label class="form-check-label" for="device_shimmer_1">Shimmer Sensor 1</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" id="device_shimmer_2" type="checkbox" value="shimmer_2">
                            <label class="form-check-label" for="device_shimmer_2">Shimmer Sensor 2</label>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label" for="recordingDuration">Max Duration (minutes)</label>
                        <input class="form-control" id="recordingDuration" max="1440" min="1" type="number" value="30">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal" type="button">Cancel</button>
                <button class="btn btn-success" onclick="createNewSession()" type="button">
                    <i class="fas fa-play me-1"></i>Start Recording
                </button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // WebSocket connection for real-time updates
    const socket = io();

    // Session data storage
    let currentSession = null;
    let sessionHistory = [];

    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
        updateConnectionStatus(true);
        loadSessionHistory();
        setupEventHandlers();
    });

    // Socket event handlers
    socket.on('connect', function() {
        console.log('Connected to dashboard server');
        updateConnectionStatus(true);
        socket.emit('request_session_info');
    });

    socket.on('disconnect', function() {
        console.log('Disconnected from dashboard server');
        updateConnectionStatus(false);
    });

    socket.on('session_info_update', function(data) {
        updateCurrentSession(data);
    });

    socket.on('status_update', function(data) {
        updateCurrentSession(data.session);
    });

    function setupEventHandlers() {
        document.getElementById('startNewSessionBtn').addEventListener('click', showNewSessionModal);
        document.getElementById('stopCurrentSessionBtn').addEventListener('click', stopCurrentSession);
    }

    function updateConnectionStatus(connected) {
        const indicator = document.getElementById('connectionIndicator');
        const status = document.getElementById('connectionStatus');

        if (connected) {
            indicator.classList.remove('disconnected');
            status.textContent = 'Connected';
        } else {
            indicator.classList.add('disconnected');
            status.textContent = 'Disconnected';
        }
    }

    function updateCurrentSession(session) {
        currentSession = session;
        const container = document.getElementById('currentSessionContent');
        const startBtn = document.getElementById('startNewSessionBtn');
        const stopBtn = document.getElementById('stopCurrentSessionBtn');

        if (session.active) {
            const startTime = new Date(session.start_time);
            const duration = calculateDuration(session.start_time);

            container.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <h6>
                            <span class="status-indicator status-recording"></span>
                            Recording in Progress
                        </h6>
                        <p class="mb-2"><strong>Session ID:</strong> ${session.session_id}</p>
                        <p class="mb-2"><strong>Started:</strong> ${startTime.toLocaleString()}</p>
                        <p class="mb-2"><strong>Duration:</strong> <span id="liveDuration">${duration}</span></p>
                        <p class="mb-0"><strong>Devices:</strong> ${(session.recording_devices || []).length} active</p>
                    </div>
                    <div class="col-md-6">
                        <div class="session-stats">
                            <h6>Data Collected</h6>
                            <div class="row">
                                <div class="col-6">
                                    <small class="text-muted">Video Files:</small><br>
                                    <strong>${session.data_collected?.video_files || 0}</strong>
                                </div>
                                <div class="col-6">
                                    <small class="text-muted">Thermal Frames:</small><br>
                                    <strong>${session.data_collected?.thermal_frames || 0}</strong>
                                </div>
                                <div class="col-6">
                                    <small class="text-muted">GSR Samples:</small><br>
                                    <strong>${session.data_collected?.gsr_samples || 0}</strong>
                                </div>
                                <div class="col-6">
                                    <small class="text-muted">Storage Used:</small><br>
                                    <strong>${session.data_collected?.storage_used || '0 MB'}</strong>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mt-3">
                    <h6>Recording Devices</h6>
                    <div class="d-flex flex-wrap gap-2">
                        ${(session.recording_devices || []).map(device =>
                            `<span class="badge bg-success">${device}</span>`
                        ).join('')}
                    </div>
                </div>
            `;

            startBtn.disabled = true;
            stopBtn.disabled = false;

            // Update live duration every second
            startLiveDurationUpdate(session.start_time);

        } else {
            container.innerHTML = `
                <div class="text-center text-muted p-4">
                    <i class="fas fa-play-circle fa-3x mb-3"></i>
                    <h5>No Active Session</h5>
                    <p>Start a new recording session to begin data collection</p>
                </div>
            `;

            startBtn.disabled = false;
            stopBtn.disabled = true;

            stopLiveDurationUpdate();
        }
    }

    let durationInterval = null;

    function startLiveDurationUpdate(startTime) {
        stopLiveDurationUpdate();
        durationInterval = setInterval(() => {
            const durationEl = document.getElementById('liveDuration');
            if (durationEl) {
                durationEl.textContent = calculateDuration(startTime);
            }
        }, 1000);
    }

    function stopLiveDurationUpdate() {
        if (durationInterval) {
            clearInterval(durationInterval);
            durationInterval = null;
        }
    }

    function calculateDuration(startTime) {
        if (!startTime) return '00:00:00';

        const start = new Date(startTime);
        const now = new Date();
        const duration = Math.floor((now - start) / 1000);

        const hours = Math.floor(duration / 3600);
        const minutes = Math.floor((duration % 3600) / 60);
        const seconds = duration % 60;

        return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }

    function loadSessionHistory() {
        // Simulate loading session history
        // In real implementation, this would fetch from the server
        const mockSessions = [
            {
                id: 'session_20250802_001',
                name: 'Baseline Recording',
                start_time: '2025-08-02T10:30:00Z',
                end_time: '2025-08-02T11:00:00Z',
                duration: 1800,
                devices: ['android_1', 'android_2', 'webcam_1'],
                status: 'completed',
                data_size: '2.5 GB'
            },
            {
                id: 'session_20250802_002',
                name: 'Stress Test',
                start_time: '2025-08-02T14:15:00Z',
                end_time: '2025-08-02T14:45:00Z',
                duration: 1200,
                devices: ['android_1', 'shimmer_1', 'shimmer_2'],
                status: 'completed',
                data_size: '1.8 GB'
            }
        ];

        displaySessionHistory(mockSessions);
        updateSessionStatistics(mockSessions);
    }

    function displaySessionHistory(sessions) {
        const container = document.getElementById('sessionHistoryContent');

        if (sessions.length === 0) {
            container.innerHTML = `
                <div class="text-center text-muted p-4">
                    <i class="fas fa-history fa-2x mb-2"></i>
                    <p>No session history available</p>
                </div>
            `;
            return;
        }

        let html = '';
        sessions.forEach(session => {
            const startTime = new Date(session.start_time);
            const endTime = new Date(session.end_time);
            const statusClass = session.status === 'completed' ? 'status-completed' : 'status-error';

            html += `
                <div class="session-item mb-3 p-3 border rounded">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <h6 class="mb-1">
                                <span class="status-indicator ${statusClass}"></span>
                                ${session.name || session.id}
                            </h6>
                            <small class="text-muted">
                                ${startTime.toLocaleString()} - ${endTime.toLocaleString()}
                            </small>
                        </div>
                        <div class="col-md-3">
                            <small class="text-muted">Duration:</small><br>
                            <strong>${Math.floor(session.duration / 60)}m ${session.duration % 60}s</strong>
                        </div>
                        <div class="col-md-3 text-end">
                            <div class="btn-group" role="group">
                                <button class="btn btn-outline-primary btn-custom" onclick="viewSession('${session.id}')">
                                    <i class="fas fa-eye"></i> View
                                </button>
                                <button class="btn btn-outline-secondary btn-custom" onclick="downloadSession('${session.id}')">
                                    <i class="fas fa-download"></i> Download
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="mt-2">
                        <small class="text-muted">Devices: </small>
                        ${session.devices.map(device => `<span class="badge bg-secondary me-1">${device}</span>`).join('')}
                        <span class="ms-3"><small class="text-muted">Size: ${session.data_size}</small></span>
                    </div>
                </div>
            `;
        });

        container.innerHTML = html;
    }

    function updateSessionStatistics(sessions) {
        const totalSessions = sessions.length;
        const totalDuration = sessions.reduce((sum, session) => sum + session.duration, 0);
        const completedSessions = sessions.filter(s => s.status === 'completed').length;

        document.getElementById('totalSessions').textContent = totalSessions;
        document.getElementById('totalDuration').textContent =
            `${Math.floor(totalDuration / 3600)}h ${Math.floor((totalDuration % 3600) / 60)}m`;
        document.getElementById('totalDataSize').textContent = '4.3 GB'; // Mock data
        document.getElementById('successRate').textContent =
            totalSessions > 0 ? Math.round((completedSessions / totalSessions) * 100) + '%' : '100%';
    }

    function showNewSessionModal() {
        const modal = new bootstrap.Modal(document.getElementById('newSessionModal'));
        modal.show();
    }

    function createNewSession() {
        const sessionName = document.getElementById('sessionName').value;
        const sessionDescription = document.getElementById('sessionDescription').value;
        const duration = document.getElementById('recordingDuration').value;

        // Get selected devices
        const deviceCheckboxes = document.querySelectorAll('input[type="checkbox"]:checked');
        const selectedDevices = Array.from(deviceCheckboxes).map(cb => cb.value);

        if (selectedDevices.length === 0) {
            alert('Please select at least one recording device');
            return;
        }

        const sessionConfig = {
            name: sessionName || `Session_${new Date().toISOString().slice(0, 19).replace(/:/g, '')}`,
            description: sessionDescription,
            devices: selectedDevices,
            max_duration: parseInt(duration) * 60 // Convert to seconds
        };

        // Start session via API
        fetch('/api/session/start', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(sessionConfig)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log('Session started:', data.session_id);
                const modal = bootstrap.Modal.getInstance(document.getElementById('newSessionModal'));
                modal.hide();

                // Reset form
                document.getElementById('newSessionForm').reset();
            } else {
                alert('Failed to start session: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error starting session:', error);
            alert('Failed to start session');
        });
    }

    function stopCurrentSession() {
        if (!currentSession || !currentSession.active) {
            return;
        }

        if (confirm('Are you sure you want to stop the current recording session?')) {
            fetch('/api/session/stop', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log('Session stopped:', data.session_id);
                    // Refresh session history
                    loadSessionHistory();
                } else {
                    alert('Failed to stop session: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error stopping session:', error);
                alert('Failed to stop session');
            });
        }
    }

    function refreshSessions() {
        console.log('Refreshing session history...');
        loadSessionHistory();
    }

    function exportSessions() {
        console.log('Exporting session data...');

        fetch('/api/sessions/export', {
            method: 'GET'
        })
        .then(response => {
            if (response.ok) {
                return response.blob();
            } else {
                throw new Error('Export failed');
            }
        })
        .then(blob => {
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `session_export_${new Date().toISOString().slice(0, 10)}.json`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
            alert('Session data exported successfully');
        })
        .catch(error => {
            console.error('Error exporting sessions:', error);
            alert(`Export failed: ${error.message}`);
        });
    }

    function viewSession(sessionId) {
        console.log(`Viewing session: ${sessionId}`);

        fetch(`/api/session/${sessionId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const session = data.session;
                const details = `
Session Details:
━━━━━━━━━━━━━━━━
ID: ${session.id}
Name: ${session.name || 'Unnamed Session'}
Start Time: ${new Date(session.start_time).toLocaleString()}
End Time: ${new Date(session.end_time).toLocaleString()}
Duration: ${Math.floor(session.duration / 60)}m ${session.duration % 60}s
Devices: ${session.devices.join(', ')}
Status: ${session.status}
Data Size: ${session.data_size}
━━━━━━━━━━━━━━━━

Data Collected:
• Video Files: ${session.data_collected?.video_files || 0}
• Thermal Frames: ${session.data_collected?.thermal_frames || 0}
• GSR Samples: ${session.data_collected?.gsr_samples || 0}
• Audio Files: ${session.data_collected?.audio_files || 0}
                `;
                alert(details);
            } else {
                alert(`Failed to load session details: ${data.error}`);
            }
        })
        .catch(error => {
            console.error('Error viewing session:', error);
            alert(`Failed to load session: ${error.message}`);
        });
    }

    function downloadSession(sessionId) {
        console.log(`Downloading session: ${sessionId}`);

        if (confirm(`Download all data for session ${sessionId}? This may be a large file.`)) {
            fetch(`/api/session/${sessionId}/download`, {
                method: 'GET'
            })
            .then(response => {
                if (response.ok) {
                    return response.blob();
                } else {
                    throw new Error('Download failed');
                }
            })
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${sessionId}_data.zip`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                alert(`Session ${sessionId} downloaded successfully`);
            })
            .catch(error => {
                console.error('Error downloading session:', error);
                alert(`Download failed: ${error.message}`);
            });
        }
    }
</script>
</body>
</html>